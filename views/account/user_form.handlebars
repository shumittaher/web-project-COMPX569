<div class="boxes border shadow w-100 mx-auto text-center">

    <h2 class="mb-3">
        {{#if isEdit}}Edit Profile{{else}}Register{{/if}}
    </h2>

    {{#if message}}
        <p>{{message}}</p>
    {{/if}}

    <form class="my-2" action="" method="post">

        <div class="d-grid row-gap-2">

            <div class="form-group">
                <input id="username" required class="form-control" autofocus type="text" name="username" placeholder="Username">
                <small id="usernameFeedback" class="form-text"></small>
            </div>

            <div class="form-group">
                <input required class="form-control" type="password" name="password" placeholder="Password">
            </div>
            <div class="form-group">
                <input required class="form-control" type="password" name="confirmation" placeholder="Confirm Password">
            </div>
            <small id="passwordFeedback" class="form-text"></small>

            <hr>

            <div class="form-group d-flex align-items-center">
                <label for="fullName" class="mx-3 w-25 text-end">Full Name</label>
                <input id="fullName" required class="form-control" type="text" name="fullName" >
            </div>

            <div class="form-group d-flex align-items-center">
                <label for="dob" class="mx-3 w-25 text-end">Date of Birth</label>
                <input id="dob" required class="form-control" type="date" name="dob" >
            </div>

            <div class="form-group d-flex align-items-center">
                <label for="description" class="mx-3 w-25 text-end">Describe Yourself</label>
                <textarea id="description" required class="form-control" type="text" rows="7" name="description"></textarea>
            </div>

            <hr>

            <div class="form-group">
                <label class="mb-2"><strong>Choose Your Avatar:</strong></label>
                <div id="avatar-container" class="d-flex flex-wrap justify-content-center">
                    {{#each avatars}}
                        <img src="/public/avatarImages/{{this}}" class="m-2 avatar-img" data-avatar="{{this}}">
                    {{/each}}
                </div>
                <input type="hidden" id="selectedAvatar" name="avatar" required>
                <small id="avatarFeedback" class="form-text"></small>
            </div>

        </div>

        <div class="row justify-content-center">

            <div class="col-auto">
                <input class="btn btn-primary btn-lg mt-4" type="submit" value=
                    {{#if isEdit}}
                        "üíæ Save Changes"
                    {{else}}
                        "‚úçÔ∏è Register"
                    {{/if}}
                >
            </div>
            <div class="col-auto">
                {{#if isEdit}}
                    <button id="deleteAccountBtn" type="button" class="col btn btn-danger btn-lg mt-4">üóëÔ∏è Delete Account</button>
                {{/if}}
            </div>
        </div>

    </form>
    <small class="text-muted">
        {{#if isEdit}}
        {{else}}
        Already have an account? <a href="/account/login">Log In here.</a>
        {{/if}}
    </small>

</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const usernameField = document.querySelector('input[name="username"]');
        const passwordField = document.querySelector('input[name="password"]');
        const confirmPasswordField = document.querySelector('input[name="confirmation"]');
        const form = document.querySelector("form");
        const submitButton = form.querySelector("input[type='submit']");
        const selectedAvatarInput = document.querySelector("#selectedAvatar");
        const avatarImages = document.querySelectorAll(".avatar-img");


        const usernameFeedback = document.querySelector('#usernameFeedback');
        const passwordFeedback = document.querySelector('#passwordFeedback');
        const avatarFeedback = document.querySelector('#avatarFeedback');

        function updateFeedback(element, message, color) {
            element.textContent = message;
            element.style.color = color;
        }

        {{#if isEdit}}
            const user = {{#if user}} {{{json user}}} {{else}} null {{/if}};
            prefillEditBox()
        {{/if}}

        function prefillEditBox() {
            setInputValue(usernameField, user.username);
            setInputValue(document.querySelector('input[name="fullName"]'), user.fullName);
            setInputValue(document.querySelector('input[name="dob"]'), user.dob);
            setInputValue(document.querySelector('textarea[name="description"]'), user.description);
            avatarImages.forEach(img => {
                if (img.getAttribute("data-avatar") === user.avatar) {
                    img.style.outline = "3px solid lightpink";
                    selectedAvatarInput.value = user.avatar;
                }
            });
        }
        function setInputValue(inputElement, value) {
            if (inputElement) {
                inputElement.value = value;
                inputElement.style.backgroundColor = "#d4edda";
            }
        }

        usernameField.addEventListener("blur", async function () {
            const username = usernameField.value.trim();
            if (username === "" || username === user.username) {
                updateFeedback(usernameFeedback, "", "");
                return;
            }

            try {
                const response = await fetch(`/account/checkUserName?username=${encodeURIComponent(username)}`);
                const data = await response.json();

                if (data.available) {
                    updateFeedback(usernameFeedback, "‚úÖ Username is available", "green");
                } else {
                    updateFeedback(usernameFeedback, "‚ùå Username is already taken", "red");
                }
            } catch (error) {
                updateFeedback(usernameFeedback, "‚ö†Ô∏è Error checking username", "orange");
            }
        });

        confirmPasswordField.addEventListener("input", function() {
            if (passwordField.value !== confirmPasswordField.value) {
                updateFeedback(passwordFeedback, "‚ùå Passwords do not match.", "red");
                submitButton.disabled = true;
            } else {
                updateFeedback(passwordFeedback, "‚úÖ Passwords match.", "green");
                submitButton.disabled = false;
            }
        });

        avatarImages.forEach(img => {
            img.addEventListener("click", function () {
                console.log("hit")
                avatarImages.forEach(i => i.style.outline = "none");
                this.style.outline = "3px solid lightblue";
                selectedAvatarInput.value = this.getAttribute("data-avatar");
                updateFeedback(avatarFeedback, "", "");
            });
        });

        form.addEventListener("submit", function(event) {
            event.preventDefault();
            let avatarSelected = selectedAvatarInput.value !== "";
            let passwordFieldsMatched = passwordField.value === confirmPasswordField.value;

            if (!avatarSelected) {
                updateFeedback(avatarFeedback, "‚ö†Ô∏è Please select an avatar.", "orange");
            }
            if (!passwordFieldsMatched) {
                updateFeedback(passwordFeedback, "‚ùå Passwords do not match!", "red");
            }
            if (avatarSelected && passwordFieldsMatched) {
                form.submit();
            }
        });

        {{#if isEdit}}

            const deleteButton = document.querySelector("#deleteAccountBtn");

            deleteButton.addEventListener("click", async function () {
                if (confirm("Are you sure you want to delete your account?")) {
                    fetch("/account/delete", {
                        method: "DELETE",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });
                }
            });

        {{/if}}
    });

</script>
