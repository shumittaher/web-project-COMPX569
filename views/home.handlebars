

<div class="text-center p-5">

    <h1>
        Hello,

        {{#if user}}
            {{user.fullName}}
        {{else}}
            Guest User
        {{/if}}
    </h1>

    {{#if message}}
        <p>{{message}}</p>
    {{/if}}
</div>

<div class="p-3 bg-body-secondary rounded-3 rounded-bottom-0">

    <div id="post_form_area" class="shadow rounded bg-light">

        {{#if user}}
            <button id="post_form_collapse" data-bs-toggle="collapse" data-bs-target="#post_form_form" class="btn text-start btn-primary btn-lg py-4 px-3 w-100">
                <span id="post_form_collapse_span" style="animation-direction:normal; width:100%" class="text-nowrap fs-3 text-center d-inline-block">
                   ‚úçÔ∏è New Post
                </span>
            </button>
        {{else}}
            <a href="/account/login">
                <button class="btn text-center btn-primary btn-lg py-4 px-3 w-100">
                    <span class="fs-3">
                       üîë Please log in to post
                    </span>
                </button>
            </a>
        {{/if}}

        <div id="post_form_form" class="collapse">
            {{> articleForm existingArticle=false}}
        </div>
    </div>

</div>
<div class="bg-body-tertiary p-4 d-flex align-items-center justify-content-between">

    {{#if user}}
        <div class="form-check form-switch d-flex align-items-center">
            <input id="myPostOnlySwitch" class="me-3 form-check-input" type="checkbox">
            <label class="form-check-label fs-5" for="myPostOnlySwitch">My Articles Only</label>
        </div>
    {{else}}
        <div></div>
    {{/if}}

    <div class="d-flex align-items-center justify-content-end w-50">
            <select id="sortSelect" class="form-select">
                <option value="">Sort by</option>
                <option value="title">Title</option>
                <option value="username">Name</option>
                <option value="postTime">Date</option>
            </select>
            <select id="sortType" class="form-select ms-2">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
            </select>
    </div>

</div>
<div class="p-3 bg-body-secondary rounded-3 rounded-top-0">

    <div id="articles_area">

    </div>

</div >

<div class="modal fade" id="editArticleModal" tabindex="-1" aria-labelledby="editArticleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editArticleModalLabel">Edit Article</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {{> articleForm existingArticle=true }}
            </div>
        </div>
    </div>
</div>

<script>

    let onlyMineState = false;
    let sortSelectState = "";
    let sortTypeState = "asc";
    let articlesLoadedEvent = new CustomEvent('ArticlesLoaded');
    let sortFilterChangedEvent = new CustomEvent('SortFilterChanged');

    let userID
    {{#if user}}
        userID = {{user.id}};
        {{else}}
        userID = null;
    {{/if}}



    document.addEventListener('DOMContentLoaded', function() {
        const article_area = document.querySelector('#articles_area')
        const inputForms = document.querySelectorAll('.input_form')
        const imageUploaders = document.querySelectorAll('.imageUploader')

        {{!-- imageUploaders.forEach(uploader => {
            uploader.addEventListener("change", async function(event) {
                const file = event.target.files[0];

                if (!file) return;

                const formData = new FormData();
                formData.append("imageFile", file);

                try {
                    const response = await fetch("/api/uploadImage", {
                        method: "POST",
                        body: formData
                    });

                    const result = await response.json();
                    if (response.ok) {
                        console.log("Upload successful:", result);
                    } else {
                        console.error("Upload failed:", result);
                    }
                } catch (error) {
                    console.error("Error uploading image:", error);
                }
            })
        }) --}}


        document.addEventListener('SortFilterChanged', ()=>{
            refreshArticles(article_area);
        })
        refreshArticles(article_area);
        setSortingListeners()

    });

    document.addEventListener('ArticlesLoaded', function() {

        const articleCards = document.querySelectorAll('.articlesCard');
        articleCards.forEach(async function(articleCard) {
            await insertComments(articleCard, articleCard.dataset.articleId, 'comment')
            await refreshLikeCount(articleCard.dataset.articleId);
        })


        {{#if user}}
            updateArticleDetails(articleCards);
            function updateArticleDetails(articleCards) {
                articleCards.forEach(async function(articleCard) {

                    const articleID = articleCard.dataset.articleId
                    const userID = {{user.id}}

                    const response = await fetchLikeStatus(articleID, userID)
                    const isLiked = response.userLikedThis
                    setLiked(articleID, isLiked)

                    document.querySelectorAll(`#like-status-${articleID} button`).forEach( (button)=> {
                        button.addEventListener('click', function() {
                            toggleLike(articleID, userID)
                        })
                    })


                })
            }

            function setLiked(articleID, isLiked) {
                const likeButton = document.querySelector(`#like-status-${articleID} .addLikeButton`);
                const removeLikeButton = document.querySelector(`#like-status-${articleID} .removeLikeButton`)

                if (isLiked) {
                    likeButton.classList.add('d-none')
                    removeLikeButton.classList.remove('d-none')
                } else {
                    likeButton.classList.remove('d-none')
                    removeLikeButton.classList.add('d-none')
                }

                document.querySelector(`#like-status-${articleID}`).classList.remove('opacity-0')
            }

            async function toggleLike(articleID, userID) {
                const response = await fetch(`/api/toggleLike/${articleID}/${userID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                if (response.status === 200) {
                    const data = await response.json();
                    setLiked(articleID, data.liked)
                }
                await refreshLikeCount(articleID);
            }

        {{/if}}

    })

    async function refreshLikeCount(articleId) {
        const likeCountSpace = document.querySelector(`#like-count-${articleId}`);
        const response = await fetch(`/api/getLikeCount/${articleId}`)
        if (response.status === 200) {
            const data = await response.json();
            likeCountSpace.innerText = "‚¨ÜÔ∏è " + data.like_count
        }
    }

    async function loadCommentClicked(articleID, commentOnComment) {
        let articleCard
        let route
        if (commentOnComment){
            articleCard = document.querySelector(`#comment-${articleID}`)
            route = 'commentOnComment'
        } else {
            articleCard = document.querySelector(`#article-${articleID}`)
            route = 'comment'
        }
        await insertComments(articleCard, articleID, route)
    }

    async function editClicked(articleId) {

        const response = await fetch(`/api/article/${articleId}`);
        const article = await response.json();
        const {title, content} = article

        quill2.root.innerHTML = content

        document.querySelector("#editArticleForm .articleTitleInput").value = title
        document.querySelector("#editArticleForm .editArticleId").value = articleId

        const editModal = new bootstrap.Modal(document.querySelector("#editArticleModal"));
        editModal.show();
    }

    async function deleteClicked(articleId){

        const response = await fetch(`/api/deleteArticle/${articleId}`);
        const data = await response.text()
        if (data === 'Success') {
            document.dispatchEvent(sortFilterChangedEvent)
        }
    }

    async function aiSummaryClicked(articleId) {
        const btn = document.getElementById(`aiSummaryBtn-${articleId}`);
        const originalHtml = btn ? btn.innerHTML : "ü§ñ AI Summary";

        try {
            if (btn) {
            btn.disabled = true;
            btn.innerHTML = `
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Generating...
            `;
            }

            const response = await fetch(`/api/ai/aiSummary/${articleId}`);
            const data = await response.json();

            if (!response.ok) {
            throw new Error(data?.error || "Failed to generate summary");
            }

            document.dispatchEvent(sortFilterChangedEvent);

        } catch (err) {
            console.error(err);
            alert(err.message);

        } finally {
            if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            }
        }
    }

    async function deleteCommentClicked(commentId){

        const response = await fetch(`/api/deleteComment/${commentId}`);
        const data = await response.text()
        if (data === 'Success') {
            document.dispatchEvent(sortFilterChangedEvent)
        }
    }

    function setNewArticleFormAnimationLogic(){
        const post_form_collapse = document.querySelector('#post_form_collapse')
        const post_form_collapse_span = document.querySelector('#post_form_collapse_span')

        post_form_collapse.addEventListener('click', ()=>{

            post_form_collapse.classList.toggle('btn-primary')
            post_form_collapse_span.style.width = post_form_collapse_span.style.width==='100%'?'0%':'100%'
            post_form_collapse_span.classList.toggle('animation_div_size')
        })

        post_form_collapse_span.addEventListener('animationend', ()=>{
            post_form_collapse_span.classList.toggle('animation_div_size')
            post_form_collapse_span.style.animationDirection = post_form_collapse_span.style.animationDirection==='normal'?'reverse':'normal'
        })
    }

    function setSortingListeners() {

        {{#if user}}
            setNewArticleFormAnimationLogic()

            const onlyMineSwitch = document.querySelector('#myPostOnlySwitch')
            onlyMineSwitch.addEventListener('click', ()=>{
                onlyMineState = onlyMineSwitch.checked;
                document.dispatchEvent(sortFilterChangedEvent)
            })

        {{/if}}

        const sort_select = document.querySelector('#sortSelect')
        sort_select.addEventListener('change', ()=>{
            sortSelectState = sort_select.value
            document.dispatchEvent(sortFilterChangedEvent)
        })

        const sort_type = document.querySelector('#sortType')
        sort_type.addEventListener('change', ()=>{
            sortTypeState = sort_type.value
            document.dispatchEvent(sortFilterChangedEvent)
        })
    }

    async function refreshArticles(wheretoPut) {
        const filters = getFilters()
        const sorts = getSorts()
        try {
            const response = await fetch('/api/showArticles', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filters,
                    sorts
                })
            });
            wheretoPut.innerHTML = await response.text();
            document.dispatchEvent(articlesLoadedEvent);
        } catch (error) {
            wheretoPut.innerHTML = 'Error fetching articles: ' + error
        }
    }

    async function fetchLikeStatus(articleId, userId){
        const response = await fetch(`/api/getUserLikeStatus/${articleId}/${userId}`)
        return await response.json();
    }

    function getFilters() {
        return {
            'filterByUser': onlyMineState
        }
    }

    function getSorts() {
        return {
            sortSelectState: sortSelectState,
            sortTypeState: sortTypeState
        }
    }

    async function insertComments(articleCard, articleID, route) {

        const response = await fetch(`/api/${route}/${articleID}`)
        const content = await response.text()

        const underlyingCommentBox = articleCard.querySelector('.commentsViewBox')

        if (content === 'false') {
            underlyingCommentBox.innerHTML = `<h6 class="text-center text-muted">No Comments Yet</h6>`
            return;
        }

        underlyingCommentBox.innerHTML = content
        underlyingCommentBox.classList.add('p-2')

    }
</script>


